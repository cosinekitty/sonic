<html>
<head>
<title>Sonic to C++ Translation</title>
</head>

<body bgcolor="lightcyan">
<h2 align="center">Sonic to C++ Translation</h2>

The current implementation of the <a href="index.html">Sonic programming language</a> is a translator which reads Sonic source code and generates C++ target code.  I chose this approach because it would be much easier than writing a true object code compiler, plus the result would be portable to many other operating systems.  I chose C++ as the target language because it is available on so many platforms and the language lends itself to good runtime performance.
<p>
The best way to go &quot;under the hood&quot; of the translator is with an example.  Let's return to the <a href="example1.html">sample program</a> we have already seen:

<hr>
<blockquote><pre>
program mix ( inWave1:wave, inWave2:wave, outWave:wave )
{
    outWave[c,i] = inWave1[c,i] + inWave2[c,i];
}
</pre></blockquote>
<hr>

After running the Sonic/C++ translator on the file containing this source code, we would obtain a file called 'mix.cpp'.  Note that the filename is derived from the name of the 'program' construct.
<p>
<a href="mix.cpp">Here is the C++ code generated by the above Sonic program.</a>
<p>
You may wish to print this file or open it in another browser window for convenient reference while reading the following discussion.
<p>
<b>Sampling Rate and Number of Channels</b><br>
In the current version of Sonic, the sampling rate and number of channels must be the same for all input and output files processed by a given program.  The constants '<tt>SamplingRate</tt>' and '<tt>NumChannels</tt>' in the output C++ source define these values for the entire program.  Their default values are 44100 Hz and 2 channels (CD quality).  The programmer may override these defaults by explicitly defining certain 
<a href="manual.html#syntax_constant">built-in constants</a>.  For example, if the programmer wanted to create a monaural audio file with a 22050 Hz sampling rate, the following Sonic code would be used:
<blockquote><pre>
r = 22050;   // override default sampling rate
m = 1;       // override default number of channels

program mix ( inWave1:wave, inWave2:wave, outWave:wave )
{
    outWave[c,i] = inWave1[c,i] + inWave2[c,i];
}
</pre></blockquote>

<p>
<b>Useful Math Constants</b><br>
The constants '<tt>pi</tt>' and '<tt>e</tt>' are defined for use by any occurrences of them in Sonic expressions.

<p>
<b>Function Prototypes</b><br>
Sonic requires the programmer to define one or more <i>functions</i>.  One of the functions must use the '<tt>program</tt>' keyword (to indicate where execution should begin), and the rest must use the '<tt>function</tt>' keyword.  The translator generates C++ prototype declarations for all functions before generating <tt>main()</tt> and the C++ translations of the Sonic functions.  Therefore, functions may appear in any order in the Sonic source code, regardless of which functions call which.  This allows things like mutual recursion between two functions without the syntactic overhead of a forward reference mechanism.  
<p>
By the way, the C++ functions are all given names based on their names in Sonic.  However, the prefix '<tt>f_</tt>' is added to each name.  This is done so that it is not possible to conflict with any reserved words or other symbols which exist in C++ but not Sonic.  For example, it is valid to name a Sonic function '<tt>template</tt>', even though this is a reserved word in C++, because the C++ function name will be '<tt>f_template</tt>'.
<p>
<b>The Function<tt> main() </tt>Is Startup Code</b><br>
You might think that the <tt>program</tt> function in the Sonic source code would become the function <tt>main()</tt> in the C++ target code.  This is not quite the case.  Consider the following points.
<ul>
	<li>Sonic is designed to create programs that accept command-line parameters.</li>
	<li>The arguments of the program function come directly from the command line.</li>
	<li>Floating point audio generated by program function must be converted to fixed point before the program terminates.
	<li>Otherwise, a program function and a non-program function should be conceptually equivalent.  For example, a recursive program function should be perfectly legitimate.</li>
</ul>
These design goals made me decide to convert all Sonic functions, including the program function, into C++ functions with like names.  The job of <tt>main()</tt> is to validate and process the command line, then call the program function, and finally to convert floating point output to fixed point output.
<p>
<b>The Sonic Functions</b><br>
After<tt> main()</tt>, the Sonic/C++ translator generates C++ target code for the program function, then target code for every non-program function in the order it appears in the source code.
<p>
<b>A Wave Assignment</b><br>
There are two categories of assignment statements in Sonic: 
<a href="manual.html#syntax_statement_simple_assignment">simple assignments</a> and 
<a href="manual.html#syntax_statement_wave_assignment">wave assignments</a>.  A simple assignment is one that assigns a new value to a variable of numeric or boolean type, e.g.,
<blockquote><pre>
duration = 5 * sqrt(x);
</pre></blockquote>
A simple assignment in Sonic gets converted to a familiar C++ assignment statement in a fairly literal manner.
<p>
On the other hand, a wave assignment is more complex in its semantics, and it results in a larger amount of C++ target code.  Wave assignments can be identified in a Sonic program by two traits: (1) The variable on the left side of the equal sign is of type <tt>wave</tt>, and (2) the variable is followed by either <tt>[c,i]</tt> or <tt>[c,i:<i>expression</i>]</tt>, where <tt><i>expression</i></tt> defines an explicit number of samples in the output.

<hr>
<p align="center"><font size="+1">
Previous Section: <a href="example1.html">A Sample Program Written in Sonic</a><br>
Next Section: <a href="manual.html">The Sonic User Manual</a><br>
<a href="index.html">Return to Sonic Home Page</a>
</font></p>
</body>
</html>
